<!DOCTYPE html>
<html>
<head>
  <title>Inventario</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <span>Farmacias Comunitarias ‚Äî Inventario</span>
      <button onclick="cerrarSesion()" class="btn-link">Cerrar sesi√≥n</button>
    </div>

    <h1>Gesti√≥n de Inventario</h1>

    <div class="seccion">
      <h3>Agregar / Actualizar Producto</h3>
      <input id="nombre" placeholder="Nombre del producto"><br><br>
      <input id="precio" type="number" placeholder="Precio" min="0"><br><br>
      <input id="stock" type="number" placeholder="Stock" min="0"><br><br>
      <button onclick="guardar()">Guardar Producto</button>
    </div>

    <div class="seccion">
      <h3>üì¶ Inventario Actual</h3>
      <table>
        <thead><tr><th>Producto</th><th>Precio</th><th>Stock</th><th>Estado</th></tr></thead>
        <tbody id="tabla"></tbody>
      </table>
    </div>

    <p id="mensaje" style="font-weight:bold; color:green;"></p>
    <br>
    <a href="admin.html">‚Üê Volver al panel</a>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, getDocs, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    onAuthStateChanged(auth, user => {
      if (!user) { window.location = "login.html"; return; }
      const rol = sessionStorage.getItem("rol");
      if (rol !== "administrador") { window.location = "login.html"; return; }
      cargar();
    });

    window.guardar = async function() {
      const nombre = document.getElementById("nombre").value.trim();
      const precio = Number(document.getElementById("precio").value);
      const stock = Number(document.getElementById("stock").value);
      if (!nombre || !precio) { alert("Completa nombre y precio"); return; }

      await addDoc(collection(db, "productos"), {
        nombre, precio, stock,
        fechaAgregado: Timestamp.now()
      });

      document.getElementById("mensaje").textContent = `‚úÖ ${nombre} guardado correctamente`;
      document.getElementById("nombre").value = "";
      document.getElementById("precio").value = "";
      document.getElementById("stock").value = "";
      cargar();
    };

    async function cargar() {
      const snap = await getDocs(collection(db, "productos"));
      const tb = document.getElementById("tabla");
      tb.innerHTML = "";

      snap.forEach(d => {
        const p = d.data();
        const alerta = p.stock < 5 ? `<span class="alerta-stock">‚ö†Ô∏è Stock bajo</span>` : `<span class="ok-stock">‚úî OK</span>`;
        tb.innerHTML += `<tr>
          <td>${p.nombre}</td>
          <td>$${p.precio}</td>
          <td>${p.stock}</td>
          <td>${alerta}</td>
        </tr>`;
      });
    }

    window.cerrarSesion = async function() {
      await signOut(auth);
      sessionStorage.clear();
      window.location = "login.html";
    };
  </script>
</body>
</html>
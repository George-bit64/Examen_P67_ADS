<!DOCTYPE html>
<html>
<head>
  <title>Crear Cuenta - Farmacia</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="img/logo.png" alt="Logo Farmacia">
    </div>
    <h2>Crear Cuenta</h2>
    <p class="subtitulo">Regístrate para hacer pedidos</p>

    <input id="nombre" type="text" placeholder="Nombre completo"><br><br>
    <input id="email" type="email" placeholder="Correo electrónico"><br><br>
    <input id="password" type="password" placeholder="Contraseña (mínimo 6 caracteres)"><br><br>
    <input id="password2" type="password" placeholder="Confirmar contraseña"><br><br>

    <button onclick="registrar()">Crear cuenta</button>

    <p id="mensaje" style="font-weight:bold; margin-top:16px;"></p>

    <br>
    <p style="text-align:center;">
      ¿Ya tienes cuenta? <a href="login.html">Iniciar sesión</a>
    </p>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    window.registrar = async function() {
      const nombre   = document.getElementById("nombre").value.trim();
      const email    = document.getElementById("email").value.trim();
      const pass     = document.getElementById("password").value.trim();
      const pass2    = document.getElementById("password2").value.trim();
      const msg      = document.getElementById("mensaje");

      // Validaciones
      if (!nombre || !email || !pass || !pass2) {
        msg.style.color = "red";
        msg.textContent = "Por favor completa todos los campos";
        return;
      }

      if (pass.length < 6) {
        msg.style.color = "red";
        msg.textContent = "La contraseña debe tener al menos 6 caracteres";
        return;
      }

      if (pass !== pass2) {
        msg.style.color = "red";
        msg.textContent = "Las contraseñas no coinciden";
        return;
      }

      try {
        // Crear usuario en Firebase Authentication
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;

        // Guardar datos en Firestore con rol "cliente" fijo
        await setDoc(doc(db, "usuarios", uid), {
          nombre: nombre,
          rol: "cliente",
          email: email,
          fechaRegistro: new Date().toISOString()
        });

        msg.style.color = "green";
        msg.textContent = "✅ Cuenta creada correctamente. Redirigiendo...";

        // Guardar sesión y redirigir al catálogo
        sessionStorage.setItem("rol", "cliente");
        sessionStorage.setItem("nombre", nombre);
        sessionStorage.setItem("uid", uid);

        setTimeout(() => {
          window.location = "catalogo.html";
        }, 1500);

      } catch(e) {
        msg.style.color = "red";
        if (e.code === "auth/email-already-in-use") {
          msg.textContent = "Ese correo ya está registrado. ¿Ya tienes cuenta?";
        } else if (e.code === "auth/invalid-email") {
          msg.textContent = "El correo no tiene un formato válido";
        } else {
          msg.textContent = "Error al crear la cuenta. Intenta de nuevo.";
        }
      }
    };
  </script>
</body>
</html>
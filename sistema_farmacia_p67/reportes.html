<!DOCTYPE html>
<html>
<head>
  <title>Reportes</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <span>Farmacias Comunitarias ‚Äî Reportes</span>
    </div>

    <h1>Reporte de Ventas</h1>

    <button onclick="cargarReporte()">üìä Generar Reporte</button>

    <div class="seccion" id="reporte" style="display:none">
      <p>Total ventas registradas: <b id="totalVentas">0</b></p>
      <p>Monto total: <b>$<span id="montoTotal">0</span></b></p>
      <p>Ventas manuales: <b id="ventasManuales">0</b></p>
      <p>Pedidos despachados: <b id="pedidosDespachados">0</b></p>
      <table>
        <thead><tr><th>Tipo</th><th>Producto/Pedido</th><th>Total</th><th>Fecha</th></tr></thead>
        <tbody id="tablaVentas"></tbody>
      </table>
    </div>

    <br>
    <a href="admin.html">‚Üê Volver al panel</a>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    onAuthStateChanged(auth, user => {
      if (!user) { window.location = "login.html"; return; }
      const rol = sessionStorage.getItem("rol");
      if (rol !== "administrador") { window.location = "login.html"; return; }
    });

    window.cargarReporte = async function() {
      const snap = await getDocs(collection(db, "ventas"));
      let total = 0, manuales = 0, despachados = 0;
      const tb = document.getElementById("tablaVentas");
      tb.innerHTML = "";

      snap.forEach(d => {
        const v = d.data();
        total += v.total || 0;
        if (v.tipo === "manual") manuales++;
        else despachados++;

        const fecha = v.fecha ? new Date(v.fecha.seconds * 1000).toLocaleDateString() : "-";
        tb.innerHTML += `<tr>
          <td>${v.tipo}</td>
          <td>${v.producto || "Pedido"}</td>
          <td>$${v.total}</td>
          <td>${fecha}</td>
        </tr>`;
      });

      document.getElementById("totalVentas").textContent = snap.size;
      document.getElementById("montoTotal").textContent = total;
      document.getElementById("ventasManuales").textContent = manuales;
      document.getElementById("pedidosDespachados").textContent = despachados;
      document.getElementById("reporte").style.display = "block";
    };
  </script>
</body>
</html>
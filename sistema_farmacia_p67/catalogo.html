<!DOCTYPE html>
<html>
<head>
  <title>CatÃ¡logo</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <span>Farmacias Comunitarias</span>
      <button onclick="cerrarSesion()" class="btn-link">Cerrar sesiÃ³n</button>
    </div>

    <h1>CatÃ¡logo de Productos</h1>
    <p>Bienvenido, <b id="nombre"></b></p>

    <div id="catalogo" class="catalogo-grid">
      <p>Cargando productos...</p>
    </div>

    <br>
    <h3>Tu carrito</h3>
    <div id="carrito"></div>
    <button onclick="enviarPedido()" id="btnPedido" style="display:none">Enviar Pedido</button>
    <p id="mensajePedido" style="font-weight:bold; color:green;"></p>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, getDocs, addDoc, doc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    let carrito = [];
    let userActual = null;

    onAuthStateChanged(auth, user => {
      if (!user) { window.location = "login.html"; return; }
      userActual = user;
      document.getElementById("nombre").textContent = sessionStorage.getItem("nombre") || user.email;
      cargarCatalogo();
    });

    async function cargarCatalogo() {
      const snap = await getDocs(collection(db, "productos"));
      const div = document.getElementById("catalogo");
      div.innerHTML = "";

      snap.forEach(d => {
        const p = { id: d.id, ...d.data() };
        div.innerHTML += `
          <div class="producto-card">
            <div class="producto-emoji">ðŸ’Š</div>
            <h3>${p.nombre}</h3>
            <p class="precio">$${p.precio}</p>
            <p class="stock ${p.stock < 5 ? 'stock-bajo' : ''}">
              Stock: ${p.stock} ${p.stock < 5 ? 'âš ï¸ Bajo' : ''}
            </p>
            <button onclick='agregarCarrito(${JSON.stringify(p)})' 
              ${p.stock === 0 ? 'disabled' : ''}>
              ${p.stock === 0 ? 'Sin stock' : 'Agregar al pedido'}
            </button>
          </div>`;
      });
    }

    window.agregarCarrito = function(producto) {
      const existe = carrito.find(c => c.id === producto.id);
      if (existe) existe.cantidad++;
      else carrito.push({ ...producto, cantidad: 1 });
      renderCarrito();
    };

    function renderCarrito() {
      const div = document.getElementById("carrito");
      if (carrito.length === 0) { div.innerHTML = "<p>Carrito vacÃ­o</p>"; document.getElementById("btnPedido").style.display = "none"; return; }

      div.innerHTML = carrito.map(c =>
        `<p>â€¢ ${c.nombre} x${c.cantidad} = $${c.precio * c.cantidad}</p>`
      ).join("") + `<p><b>Total: $${carrito.reduce((a,c) => a + c.precio*c.cantidad, 0)}</b></p>`;

      document.getElementById("btnPedido").style.display = "inline-block";
    }

    window.enviarPedido = async function() {
      if (!userActual || carrito.length === 0) return;

      const total = carrito.reduce((a,c) => a + c.precio*c.cantidad, 0);

      await addDoc(collection(db, "pedidos"), {
        uid: userActual.uid,
        nombre: sessionStorage.getItem("nombre") || userActual.email,
        items: carrito,
        total,
        estado: "pendiente",
        fecha: Timestamp.now()
      });

      document.getElementById("mensajePedido").textContent = "âœ… Pedido enviado correctamente";
      carrito = [];
      renderCarrito();
    };

    window.cerrarSesion = async function() {
      await signOut(auth);
      sessionStorage.clear();
      window.location = "login.html";
    };
  </script>
</body>
</html>